CREATE DATABASE SALES_MANAGEMENT
GO

USE SALES_MANAGEMENT
GO

CREATE TABLE NHANVIEN
(
	MANV VARCHAR(20) NOT NULL,
	PASSWORD VARCHAR(100) NOT NULL,
	TEN NVARCHAR(50),
	NGAYSINH SMALLDATETIME,
	GIOITINH NVARCHAR(10),
	SDT VARCHAR(20),
	DIACHI NVARCHAR(100),
	ANH TEXT,
	CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV)
)
GO

CREATE TABLE QUANLY
(
	MAQL VARCHAR(20) NOT NULL,
	PASSWORD VARCHAR(100) NOT NULL,
	TEN NVARCHAR(50),
	NGAYSINH SMALLDATETIME,
	GIOITINH NVARCHAR(10),
	SDT VARCHAR(20),
	DIACHI NVARCHAR(100),
	ANH TEXT,
	CONSTRAINT PK_QUANLY PRIMARY KEY (MAQL),
)
GO

CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(20) NOT NULL,
	TEN NVARCHAR(50),
	NGAYSINH SMALLDATETIME,
	GIOITINH NVARCHAR(10),
	SDT VARCHAR(20),
	DIACHI NVARCHAR(100),
	DIEM INT,
	ANH TEXT,
	CONSTRAINT PK_KHACHHANG PRIMARY KEY (MAKH),
)
GO

CREATE TABLE SANPHAM
(
	MASP VARCHAR(20) NOT NULL,
	TEN NVARCHAR(100),
	SOLUONG INT,
	DVT NVARCHAR(50),
	GIANHAP INT,
	GIABANLE INT,
	HSD SMALLDATETIME,
	NHACUNGCAP NVARCHAR(100),
	GHICHU NVARCHAR(100),
	CONSTRAINT PK_SANPHAM PRIMARY KEY (MASP)
)
GO

CREATE TABLE HOADON
(
	MAHD VARCHAR(20) NOT NULL,
	MANV VARCHAR(20) NOT NULL,
	MAKH VARCHAR(20),
	THOIGIAN SMALLDATETIME,
	TONGGIATRI INT,
	CONSTRAINT PK_HOADON PRIMARY KEY (MAHD)
)
GO

CREATE TABLE CTHD
(
	MAHD VARCHAR(20) NOT NULL,
	MASP VARCHAR(20) NOT NULL,
	TEN NVARCHAR(100),
	SOLUONG INT,
	DVT NVARCHAR(50),
	DONGIA INT,
	TRIGIA INT,
	CONSTRAINT PK_CTHD PRIMARY KEY (MAHD, MASP)
)
GO

ALTER TABLE CTHD
ADD CONSTRAINT FK_CTHD_HOADON_MAHD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD)
GO

set dateformat dmy
-- SANPHAM
INSERT INTO SANPHAM VALUES ('3694362852260',N'Coca Cola 330ml',43,N'Lon',8000,10000,'25/08/2021',N'Coca-Cola',N'')
INSERT INTO SANPHAM VALUES ('6175747286674',N'7Up 330ml',48,N'Lon',8000,10000,'12/05/2021',N'Pepsi',N'')
INSERT INTO SANPHAM VALUES ('8738772500405',N'Pepsi 330ml',46,N'Lon',8000,10000,'09/06/2021',N'Pepsi',N'')
INSERT INTO SANPHAM VALUES ('9709955748951',N'Bánh Chocopie',12,N'Hộp',43000,48000,'14/07/2021',N'Orion Vina',N'')
INSERT INTO SANPHAM VALUES ('7903887909141',N'Mỳ Hảo Hảo Tôm chua cay',36,N'Gói',2500,3000,'03/05/2021',N'ACECOOK',N'')
INSERT INTO SANPHAM VALUES ('9303914296905',N'Mỳ Omachi Xốt bò hầm',28,N'Gói',5500,6000,'17/08/2021',N'Masan',N'')
INSERT INTO SANPHAM VALUES ('6429981858495',N'Bánh AFC Vị lúa mì 200g',6,N'Hộp',24000,27000,'22/05/2021',N'Kinh Đô',N'')
INSERT INTO SANPHAM VALUES ('9798371282668',N'Sữa Milo 180ml',32,N'Hộp',6000,7000,'18/05/2021',N'MILO',N'')
INSERT INTO SANPHAM VALUES ('7795105401069',N'Cà phê NESCAFE ESPRESSODA 330ml',14,N'Lon',10000,12000,'27/07/2021',N'NESCAFE',N'')
INSERT INTO SANPHAM VALUES ('3925444825477',N'Sữa đậu nành Fami 200ml',24,N'Bịch',3500,4000,'29/03/2021',N'Vinasoy',N'')

-- NHANVIEN
INSERT INTO NHANVIEN VALUES ('NV001','161217381747022820119720656236237850238247',N'Nguyễn Văn An','01/01/2001',N'Nam','0935735816',N'Thủ Đức, TPHCM', NULL)
INSERT INTO NHANVIEN VALUES ('NV002','2282422021244143248137221361901441482301237',N'Trần Trung Hiếu','10/10/2000',N'Nam','0914758372',N'Bình Thạnh, TPHCM', NULL)
INSERT INTO NHANVIEN VALUES ('NV003','36861675317221110947128204921723013142242',N'Trần Như Phương','21/08/1998',N'Nữ','0924587183',N'Dĩ An, Bình Dương', NULL)

-- QUANLY
INSERT INTO QUANLY VALUES ('QL001','13541541422814327128216551122161791976217',N'Vũ Minh Lộc','16/03/1992',N'Nam','0912517683',N'Thủ Đức, TPHCM', NULL)

-- KHACHHANG
INSERT INTO KHACHHANG VALUES ('KH00000', N'None', '01/01/2001', N'Nam', '1234567890', N'None', 0, NULL)
INSERT INTO KHACHHANG VALUES ('KH00001',N'Trần Thanh','01/01/1990',N'Nam','0915387624',N'Thủ Đức, TPHCM',145, NULL)
INSERT INTO KHACHHANG VALUES ('KH00002',N'Lê Trung Hậu','05/04/1983',N'Nam','0925743651',N'Bình Thạnh, TPHCM',82, NULL)
INSERT INTO KHACHHANG VALUES ('KH00003',N'Nguyễn Thu Trang','25/07/1997',N'Nữ','0913582486',N'Dĩ An, Bình Dương',117, NULL)

-- HOADON
INSERT INTO HOADON VALUES ('20SEP0001', 'NV001', 'KH00001', '03/09/2020', 144000)
INSERT INTO HOADON VALUES ('20OCT0001', 'NV002', 'KH00002', '05/10/2020', 98000)
INSERT INTO HOADON VALUES ('20OCT0002', 'NV001', 'KH00003', '14/10/2020', 80000)
INSERT INTO HOADON VALUES ('20NOV0001', 'NV003', 'KH00001', '07/11/2020', 93000)
INSERT INTO HOADON VALUES ('20NOV0002', 'NV003', 'KH00002', '18/11/2020', 80000)

-- CTHD
INSERT INTO CTHD VALUES ('20SEP0001', '3694362852260', N'Coca Cola 330ml', 4, N'Lon', 10000, 40000)
INSERT INTO CTHD VALUES ('20SEP0001', '8738772500405', N'Pepsi 330ml', 5, N'Lon', 10000, 50000)
INSERT INTO CTHD VALUES ('20SEP0001', '6429981858495', N'Bánh AFC Vị lúa mì 200g', 2, N'Hộp', 27000, 54000)
INSERT INTO CTHD VALUES ('20OCT0001', '7795105401069', N'Cà phê NESCAFE ESPRESSODA 330ml', 3, N'Lon', 12000, 36000)
INSERT INTO CTHD VALUES ('20OCT0001', '9709955748951', N'Bánh Chocopie', 1, N'Hộp', 48000, 48000)
INSERT INTO CTHD VALUES ('20OCT0001', '9798371282668', N'Sữa Milo 180ml', 2,  N'Hộp', 7000, 14000)
INSERT INTO CTHD VALUES ('20OCT0002', '3925444825477', N'Sữa đậu nành Fami 200ml', 5, N'Bịch', 4000, 20000)
INSERT INTO CTHD VALUES ('20OCT0002', '6175747286674', N'7Up 330ml', 3, N'Lon', 10000, 30000)
INSERT INTO CTHD VALUES ('20OCT0002', '9303914296905', N'Mỳ Omachi Xốt bò hầm', 5, N'Gói', 6000, 30000)
INSERT INTO CTHD VALUES ('20NOV0001', '7903887909141', N'Mỳ Hảo Hảo Tôm chua cay', 5, N'Gói', 3000, 15000)
INSERT INTO CTHD VALUES ('20NOV0001', '9798371282668', N'Sữa Milo 180ml', 3,  N'Hộp', 7000, 21000)
INSERT INTO CTHD VALUES ('20NOV0001', '6429981858495', N'Bánh AFC Vị lúa mì 200g', 1, N'Hộp', 27000, 27000)
INSERT INTO CTHD VALUES ('20NOV0001', '3694362852260', N'Coca Cola 330ml', 3, N'Lon', 10000, 30000)
INSERT INTO CTHD VALUES ('20NOV0002', '8738772500405', N'Pepsi 330ml', 3, N'Lon', 10000, 30000)
INSERT INTO CTHD VALUES ('20NOV0002', '9303914296905', N'Mỳ Omachi Xốt bò hầm', 5, N'Gói', 6000, 30000)
INSERT INTO CTHD VALUES ('20NOV0002', '6175747286674', N'7Up 330ml', 2, N'Lon', 10000, 20000)

-- chuyển chuỗi sang không dấu
CREATE FUNCTION [dbo].[fuConvertToUnsign1] ( @strInput NVARCHAR(4000) ) RETURNS NVARCHAR(4000) AS BEGIN IF @strInput IS NULL RETURN @strInput IF @strInput = '' RETURN @strInput DECLARE @RT NVARCHAR(4000) DECLARE @SIGN_CHARS NCHAR(136) DECLARE @UNSIGN_CHARS NCHAR (136) SET @SIGN_CHARS = N'ăâđêôơưàảãạáằẳẵặắầẩẫậấèẻẽẹéềểễệế ìỉĩịíòỏõọóồổỗộốờởỡợớùủũụúừửữựứỳỷỹỵý ĂÂĐÊÔƠƯÀẢÃẠÁẰẲẴẶẮẦẨẪẬẤÈẺẼẸÉỀỂỄỆẾÌỈĨỊÍ ÒỎÕỌÓỒỔỖỘỐỜỞỠỢỚÙỦŨỤÚỪỬỮỰỨỲỶỸỴÝ' +NCHAR(272)+ NCHAR(208) SET @UNSIGN_CHARS = N'aadeoouaaaaaaaaaaaaaaaeeeeeeeeee iiiiiooooooooooooooouuuuuuuuuuyyyyy AADEOOUAAAAAAAAAAAAAAAEEEEEEEEEEIIIII OOOOOOOOOOOOOOOUUUUUUUUUUYYYYYDD' DECLARE @COUNTER int DECLARE @COUNTER1 int SET @COUNTER = 1 WHILE (@COUNTER <=LEN(@strInput)) BEGIN SET @COUNTER1 = 1 WHILE (@COUNTER1 <=LEN(@SIGN_CHARS)+1) BEGIN IF UNICODE(SUBSTRING(@SIGN_CHARS, @COUNTER1,1)) = UNICODE(SUBSTRING(@strInput,@COUNTER ,1) ) BEGIN IF @COUNTER=1 SET @strInput = SUBSTRING(@UNSIGN_CHARS, @COUNTER1,1) + SUBSTRING(@strInput, @COUNTER+1,LEN(@strInput)-1) ELSE SET @strInput = SUBSTRING(@strInput, 1, @COUNTER-1) +SUBSTRING(@UNSIGN_CHARS, @COUNTER1,1) + SUBSTRING(@strInput, @COUNTER+1,LEN(@strInput)- @COUNTER) BREAK END SET @COUNTER1 = @COUNTER1 +1 END SET @COUNTER = @COUNTER +1 END SET @strInput = replace(@strInput,' ','-') RETURN @strInput END

CREATE TRIGGER TRG_DEL_KHACHHANG ON KHACHHANG
FOR DELETE
AS
BEGIN
	DECLARE @MAKH VARCHAR(20)
	SELECT @MAKH = MAKH FROM DELETED
	UPDATE HOADON
		SET MAKH = '' WHERE MAKH = @MAKH
END

CREATE TRIGGER TRG_DEL_NHANVIEN ON NHANVIEN
FOR DELETE
AS
BEGIN
	DECLARE @MANV VARCHAR(20)
	SELECT @MANV = MANV FROM DELETED
	UPDATE HOADON
	SET MANV = 'DELETED' WHERE MANV = @MANV
END

